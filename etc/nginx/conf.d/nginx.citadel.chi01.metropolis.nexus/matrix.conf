upstream matrix {
    server 192.168.2.117:8008;
    server 192.168.2.117:8009;
    server 192.168.2.117:8010;
}

server {
    listen 443 quic;
    listen 443 ssl;
    listen [::]:443 quic;
    listen [::]:443 ssl;
    listen 8443 ssl proxy_protocol;

    server_name matrix.metropolis.nexus;

    ssl_certificate /etc/letsencrypt/live/matrix.metropolis.nexus/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/matrix.metropolis.nexus/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/matrix.metropolis.nexus/chain.pem;

    include headers-more.d/universal.conf;
    include snippets/proxy.conf;

    more_set_headers "Cross-Origin-Resource-Policy: cross-origin";
    more_clear_headers X-Robots-Tag;
    more_clear_headers Cross-Origin-Embedder-Policy;

    proxy_hide_header Access-Control-Allow-Origin;
    more_set_headers  "Access-Control-Allow-Origin: *";

    proxy_hide_header Access-Control-Allow-Methods;
    more_set_headers  "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS";

    proxy_hide_header Access-Control-Allow-Headers;
    more_set_headers  "Access-Control-Allow-Headers: X-Requested-With, Content-Type, Authorization, If-None-Match, If-Match";

    client_max_body_size 25M;


    # Federation requests
    location ~ ^/_matrix/federation/v1/(version$|event/|state/|state_ids/|backfill/|get_missing_events/|publicRooms|query/|make_join/|/make_leave/|make_knock/|send_knock/|event_auth/|timestamp_to_event/|exchange_third_party_invite/|user/devices/|hierarchy/|send/) {
        proxy_pass http://matrix;
    }

    location ~ ^/_matrix/federation/(v1|v2)/(send_join/|send_leave/|invite/) {
        proxy_pass http://matrix;
    }

    location ~ ^/_matrix/key/v2/query {
        proxy_pass http://matrix;
    }

   # Inbound federation transaction request
    location ~ ^/_matrix/federation/v1/send/ {
        proxy_pass http://matrix;
    }

    # Client API requests (partial)
    location ~ ^/_matrix/client/(api/v1|r0|v3|unstable)/(createRoom$|publicRooms$) {
        proxy_pass http://matrix;
    }

    location ~ ^/_matrix/client/(api/v1|r0|v3|unstable)/rooms/(.*/joined_members$|.*/context/.*$|.*/members$|.*/state$) {
        proxy_pass http://matrix;
    }

    location ~ ^/_matrix/client/v1/rooms/(.*/hierarchy$|.*/threads$) {
        proxy_pass http://matrix;
    }

    location ~ ^/_matrix/client/(v1|unstable)/rooms/.*/relations/  {
        proxy_pass http://matrix;
    }

    location ~ ^/_matrix/client/unstable/im.nheko.summary/summary/.*$  {
        proxy_pass http://matrix;
    }

    location ~ ^/_matrix/client/(r0|v3|unstable)/account/(3pid$|whoami$|deactivate$)  {
        proxy_pass http://matrix;
    }

    location ~ ^/_matrix/client/(r0|v3)/delete_devices$  {
        proxy_pass http://matrix;
    }

    location ~ ^/_matrix/client/(api/v1|r0|v3|unstable)/(devices(/|$)|voip/turnServer$|rooms/.*/event/|joined_rooms$|/search$|/directory/room/.*$) {
        proxy_pass http://matrix;
    }

    location ~ ^/_matrix/client/versions$ {
        proxy_pass http://matrix;
    }

    location ~ ^/_matrix/client/v1/rooms/.*/timestamp_to_event$ {
        proxy_pass http://matrix;
    }

    location ~ ^/_matrix/client/(api/v1|r0|v3|unstable/.*)/rooms/.*/aliases {
        proxy_pass http://matrix;
    }

    location ^/_matrix/client/(r0|v3|unstable)/(user/.*/filter(/|$)|capabilities$|notifications$) {
        proxy_pass http://matrix;
    }

    location ^/_synapse/admin/v1/rooms/[^/]+$ {
        proxy_pass http://matrix;
    }

    # Encryption requests
    location ~ ^/_matrix/client/(r0|v3|unstable)/(keys/query$|keys/changes$|keys/claim$|room_keys/|keys/upload) {
        proxy_pass http://matrix;
    }


    location ~ ^/_matrix/client/(api/v1|r0|v3|unstable)/keys/(device_signing/upload$|signatures/upload$) {
        proxy_pass http://matrix;
    }

    # Event sending requests
    location ~ ^/_matrix/client/(api/v1|r0|v3|unstable)/(rooms/.*/redact|rooms/.*/send|rooms/.*/state/.*/(join|invite|leave|ban|unban|kick)$|join/|knock/|profile/) {
        proxy_pass http://matrix;
    }

    # User directory search requests
    location ~ ^/_matrix/client/(r0|v3|unstable)/user_directory/search$ {
        proxy_pass http://matrix;
    }

    # MAS
    location ~ ^/_synapse/admin/v2/users/[^/]+$ {
        proxy_pass http://matrix;
    }

    location ~ ^/_synapse/admin/v1/(username_available$|users/[^/]+/_allow_cross_signing_replacement_without_uia$|users/[^/]+/devices$) {
        proxy_pass http://matrix;
    }

    location / {
        proxy_pass http://192.168.2.117:8008;
    }

}

server {
    listen 443 quic;
    listen 443 ssl;
    listen [::]:443 quic;
    listen [::]:443 ssl;
    listen 8443 ssl proxy_protocol;

    server_name element.metropolis.nexus;

    ssl_certificate /etc/letsencrypt/live/matrix.metropolis.nexus/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/matrix.metropolis.nexus/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/matrix.metropolis.nexus/chain.pem;

    include headers-more.d/universal.conf;
    include snippets/proxy.conf;

    more_clear_headers X-Robots-Tag;

    more_set_headers "Cross-Origin-Resource-Policy: cross-origin";
    more_set_headers "X-Frame-Options: SAMEORIGIN";
    more_set_headers "X-Content-Type-Options: nosniff";

    more_set_headers "Permissions-Policy: accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), bluetooth=(), browsing-topics=(), clipboard-read=(), display-capture=(), document-domain=(), encrypted-media=(), fullscreen=(), gamepad=(), geolocation=(), gyroscope=(), hid=(), idle-detection=(), interest-cohort=(), keyboard-map=(), local-fonts=(), magnetometer=(), midi=(), payment=(), picture-in-picture=(), publickey-credentials-create=self, publickey-credentials-get=self, screen-wake-lock=(), serial=(), speaker-selection=(), sync-xhr=(), usb=(), xr-spatial-tracking=()";

    proxy_hide_header Content-Security-Policy;
    more_set_headers "Content-Security-Policy: default-src 'none'; connect-src 'self' https://metropolis.nexus https://matrix.metropolis.nexus https://mas.metropolis.nexus blob:; font-src 'self'; img-src 'self' https://static.metropolis.nexus/element.jpg https://matrix.metropolis.nexus blob: data:; manifest-src 'self'; media-src 'self' https://matrix.arcticfoxes.net blob: data:; script-src 'self' 'unsafe-eval'; style-src-attr 'unsafe-inline'; style-src-elem 'self' 'unsafe-inline'; frame-src 'self' blob:; frame-ancestors 'self'; upgrade-insecure-requests; base-uri 'none'";

    location / {
        proxy_pass http://192.168.2.117:8080;
    }

}

server {
    listen 443 quic;
    listen 443 ssl;
    listen [::]:443 quic;
    listen [::]:443 ssl;
    listen 8443 ssl proxy_protocol;

    server_name mas.metropolis.nexus;

    ssl_certificate /etc/letsencrypt/live/matrix.metropolis.nexus/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/matrix.metropolis.nexus/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/matrix.metropolis.nexus/chain.pem;

    include headers-more.d/universal.conf;
    include snippets/proxy.conf;

    location / {
        proxy_pass http://192.168.2.117:8081;
    }

}