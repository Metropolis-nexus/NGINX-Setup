server {
    listen 443 quic;
    listen 443 ssl;
    listen [::]:443 quic;
    listen [::]:443 ssl;
    listen 8443 ssl proxy_protocol;

    server_name auth.metropolis.nexus;

    ssl_certificate /etc/letsencrypt/live/auth.metropolis.nexus/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/auth.metropolis.nexus/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/auth.metropolis.nexus/chain.pem;

    include headers-more.d/universal.conf;
    include snippets/proxy.conf;

    more_clear_headers X-Robots-Tag;

    proxy_hide_header Content-Security-Policy;
    more_set_headers "Content-Security-Policy: default-src 'none'; connect-src 'self'; frame-src blob: https://challenges.cloudflare.com; font-src 'self'; img-src https: data:; script-src-attr 'unsafe-eval' 'unsafe-inline'; script-src-elem 'self' 'unsafe-inline' https://challenges.cloudflare.com/turnstile/v0/api.js; $style_src_type7; form-action 'none'; frame-ancestors 'none'; upgrade-insecure-requests; base-uri 'none'";

    proxy_ssl_verify on;
    proxy_ssl_name auth.metropolis.nexus;

    modsecurity on;
    modsecurity_rules '
        Include /etc/nginx/modsecurity.d/modsecurity.conf
        Include /etc/nginx/modsecurity.d/crs.conf
        Include /etc/nginx/modsecurity.d/crs-level-4.conf
        Include /etc/nginx/modsecurity.d/exclusions.conf
        Include /etc/nginx/modsecurity.d/coreruleset/rules/*.conf

        SecRuleRemoveById 931130
        SecRuleRemoveById 932240
        SecRuleRemoveById 942200
        SecRuleRemoveById 942340
        SecRuleRemoveById 942370
        SecRuleRemoveById 920230
        SecRuleRemoveById 942430
        SecRuleRemoveById 932200
        SecRuleRemoveById 920273
        SecRuleRemoveById 920272
        SecRuleRemoveById 942432
        SecRuleRemoveById 942431
        SecRuleRemoveById 942120
        SecRuleRemoveById 942460
        SecRuleRemoveById 921180
        SecRuleRemoveById 932140
        SecRuleRemoveById 942180
        SecRuleRemoveById 942300
        SecRuleRemoveById 942511
        SecRuleRemoveById 941340
        SecRuleRemoveById 942210
        SecRuleRemoveById 942440
        SecRuleRemoveById 942520
        SecRuleRemoveById 941330
        SecRuleRemoveById 942131

        # Nextcloud server crawler
        SecRuleRemoveById 920300

        # Cremean\'s rules for Cloudflare Turnsile
        SecRuleUpdateTargetById 920273 !ARGS:cf-turnstile-response
        SecRuleUpdateTargetById 942430 !ARGS:cf-turnstile-response
        SecRuleUpdateTargetById 942431 !ARGS:cf-turnstile-response
        SecRuleUpdateTargetById 942432 !ARGS:cf-turnstile-response
        SecRuleUpdateTargetById 942440 !ARGS:cf-turnstile-response
        SecRuleUpdateTargetById 942450 !ARGS:cf-turnstile-response
    ';

    # Block access to default flows

    location /if/flow/initial-setup {
        include snippets/htpasswd.conf;
        proxy_pass https://192.168.2.111:9443;
    }

    location /if/flow/default-authentication-flow {
        include snippets/htpasswd.conf;
        proxy_pass https://192.168.2.111:9443;
    } 

    location /if/flow/default-enrollment-flow {
        include snippets/htpasswd.conf;
        proxy_pass https://192.168.2.111:9443;
    }

    # Keycloak emulation

    rewrite ^/realms/metropolis-nexus/protocol/openid-connect/auth(.*)$ /application/o/authorize/$1 break;
    rewrite /realms/metropolis-nexus/protocol/openid-connect/token /application/o/token/ break;
    rewrite /realms/metropolis-nexus/protocol/openid-connect/userinfo /application/o/userinfo/ break;

    # Default proxy

    location / {
        proxy_pass https://192.168.2.111:9443;
    }

}
